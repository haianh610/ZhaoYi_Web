@using System.ComponentModel.DataAnnotations
@model IEnumerable<ZhaoYi_Test2.Models.JobPosting>
@{
    ViewData["Title"] = "Trang chủ phiên dịch viên";
    var appliedJobs = ViewBag.AppliedJobs as List<int> ?? new List<int>();
}

<div class="container">
    <div class="row mb-4">
        <div class="col-md-12">
            <div class="card">
                <div class="card-header bg-primary text-white">
                    <h5 class="mb-0">Tìm kiếm việc làm phiên dịch</h5>
                </div>
                <div class="card-body">
                    <form method="get" class="row g-3">
                        <div class="col-md-4">
                            <label for="searchTerm" class="form-label">Từ khóa</label>
                            <input type="text" class="form-control" id="searchTerm" name="searchTerm" 
                                   value="@ViewBag.SearchTerm" placeholder="Nhập từ khóa tìm kiếm...">
                        </div>
                        <div class="col-md-3">
                            <label for="location" class="form-label">Địa điểm</label>
                            <input type="text" class="form-control" id="location" name="location" 
                                   value="@ViewBag.Location" placeholder="Địa điểm làm việc...">
                        </div>
                        <div class="col-md-2">
                            <label for="minSalary" class="form-label">Lương tối thiểu</label>
                            <input type="number" class="form-control" id="minSalary" name="minSalary" 
                                   value="@ViewBag.MinSalary" placeholder="VND" min="0" step="1000000">
                        </div>
                        <div class="col-md-2">
                            <label for="experience" class="form-label">Kinh nghiệm</label>
                            <select class="form-select" id="experience" name="experience">
                                <option value="">Tất cả</option>
                                @foreach (var exp in Enum.GetValues(typeof(ZhaoYi_Test2.Models.ExperienceLevel)))
                                {
                                    var expValue = (int)exp;
                                    var isSelected = ViewBag.Experience != null && (int)ViewBag.Experience == expValue;
                                    var displayName = ((ZhaoYi_Test2.Models.ExperienceLevel)exp).GetType()
                                    .GetField(exp.ToString())
                                    .GetCustomAttributes(typeof(DisplayAttribute), false)
                                    .Cast<DisplayAttribute>()
                                    .SingleOrDefault()?.Name ?? exp.ToString();

                                    if (isSelected)
                                    {
                                        <option value="@expValue" selected>@displayName</option>
                                    }
                                    else
                                    {
                                        <option value="@expValue">@displayName</option>
                                    }
                                }
                            </select>


                        </div>
                        <div class="col-md-1 d-flex align-items-end">
                            <button type="submit" class="btn btn-primary w-100">Tìm</button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <div class="row mb-4">
        <div class="col-md-8">
            <h3>Danh sách việc làm (@Model.Count())</h3>
        </div>
        <div class="col-md-4 text-end">
            <a asp-controller="JobApply" asp-action="MyApplications" class="btn btn-outline-primary">
                <i class="bi bi-file-earmark-text"></i> Đơn ứng tuyển của tôi
            </a>
        </div>
    </div>

    @if (!Model.Any())
    {
        <div class="alert alert-info">
            Không tìm thấy việc làm nào phù hợp với tiêu chí tìm kiếm của bạn.
        </div>
    }
    else
    {
        <div class="row row-cols-1 row-cols-md-2 row-cols-lg-3 g-4">
            @foreach (var job in Model)
            {
                <div class="col">
                    <div class="card h-100 shadow-sm">
                        <div class="card-header bg-light">
                            <h5 class="card-title mb-0 text-truncate">
                                <a asp-controller="JobApply" asp-action="Details" asp-route-id="@job.JobPostingId" class="text-decoration-none">
                                    @job.Title
                                </a>
                            </h5>
                        </div>
                        <div class="card-body">
                            <div class="d-flex justify-content-between align-items-center mb-2">
                                <span class="badge bg-primary">@job.Salary.ToString("N0") VND</span>
                                <span class="badge bg-secondary">@job.ViewCount lượt xem</span>
                            </div>

                            <div class="mb-2">
                                <small class="text-muted">
                                    <i class="bi bi-building"></i> @(string.IsNullOrEmpty(job.Field) ? "Không có" : job.Field)
                                </small>
                            </div>

                            <div class="mb-2">
                                <small class="text-muted">
                                    <i class="bi bi-geo-alt"></i> @job.WorkLocation
                                </small>
                            </div>

                            <p class="card-text text-truncate">
                                @job.JobDescription
                            </p>

                            <div class="d-flex justify-content-between align-items-center">
                                <small class="text-muted">
                                    Đăng ngày @job.PostedDate.ToString("dd/MM/yyyy")
                                </small>
                                <small class="text-danger">
                                    Hết hạn: @job.ExpiryDate.ToString("dd/MM/yyyy")
                                </small>
                            </div>
                        </div>
                        <div class="card-footer bg-white">
                            <div class="d-grid gap-2">
                                @if (appliedJobs.Contains(job.JobPostingId))
                                {
                                    <button class="btn btn-outline-success" disabled>
                                        <i class="bi bi-check-circle"></i> Đã ứng tuyển
                                    </button>
                                }
                                else
                                {
                                    <a asp-controller="JobApply" asp-action="Details" asp-route-id="@job.JobPostingId" class="btn btn-primary">
                                        Xem chi tiết
                                    </a>
                                }
                            </div>
                        </div>
                    </div>
                </div>
            }
        </div>
    }
</div>
